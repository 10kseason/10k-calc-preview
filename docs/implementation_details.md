# 구현 상세 문서 (Implementation Details)

이 문서는 BMS 난이도 계산기 프로젝트의 주요 모듈과 알고리즘에 대한 상세 설명을 담고 있습니다.

## 1. 프로젝트 개요
이 프로젝트는 리듬 게임(BMS, Osu!mania)의 채보 파일을 분석하여 난이도를 계산하고, 플레이어의 생존 가능성을 예측하는 도구입니다.

## 2. 모듈별 상세 설명

### 2.1. 파서 (Parser)

#### `bms_parser.py`
- **기능**: `.bms`, `.bme` 파일을 파싱하여 노트 데이터를 추출합니다.
- **주요 로직**:
  - `parse()`: 파일을 읽어 헤더 정보와 메인 데이터(`#XXXYY:DATA`)를 분리합니다.
  - `_process_data()`:
    - 채널 매핑: 7키(1P: 11-19, 2P: 21-29) 및 롱노트(51-59, 61-69) 채널을 표준 컬럼(1-16)으로 변환합니다.
    - 시간 계산: BPM 변경(`#BPMxx`)과 정지 명령(`#STOPxx`)을 고려하여 각 노트의 정확한 초 단위 시간(`time`)을 계산합니다.
    - 롱노트(LN) 처리: LN 시작과 끝을 짝지어 `endtime`을 가진 노트 객체로 변환합니다.

#### `osu_parser.py`
- **기능**: `.osu` (Osu!mania) 파일을 파싱합니다.
- **주요 로직**:
  - `HitObjects` 섹션을 파싱하여 `x` 좌표를 기반으로 컬럼을 계산합니다. (`floor(x * KeyCount / 512)`)
  - 비트 연산을 통해 일반 노트와 롱노트(Hold Note, 128)를 구분합니다.
  - BMS 파서와 호환되는 노트 리스트 형식으로 반환합니다.

### 2.2. 메트릭 계산 (Metric Calculation)

#### `metric_calc.py`
- **기능**: 노트 데이터를 기반으로 시간 단위(윈도우)별 물리적 지표를 계산합니다.
- **주요 지표**:
  - **NPS (Notes Per Second)**: 초당 노트 수. 밀도의 기본 척도.
  - **LN Strain**: 롱노트 부하. 겹치는 롱노트의 비율 등을 고려하여 계산.
  - **Jack Penalty**: 연타(Jack) 패턴에 대한 페널티. 동일 컬럼 노트 간격이 짧을수록 값이 커짐.
  - **Alt Cost**: 손배치 교차 비용. DP(Double Play)나 특정 손배치가 강제되는 패턴에 대한 부하.

### 2.3. 난이도 모델링 (Difficulty Modeling)

#### `calc.py`
- **기능**: 메트릭을 종합하여 최종 난이도와 레벨을 산출합니다.
- **알고리즘**:
  1. **윈도우 부하 ($b_t$)**: 각 메트릭에 가중치($\alpha, \beta, \dots$)를 곱해 합산합니다.
     $$b_t = \alpha \cdot \text{NPS} + \beta \cdot \text{LN} + \gamma \cdot \text{Jack} + \dots$$
  2. **EMA (지수이동평균)**:
     - **Endurance ($F$)**: 긴 타임스케일($\lambda_L$)의 EMA 합. 전체적인 체력 요구량.
     - **Burst ($P$)**: 짧은 타임스케일($\lambda_S$)의 EMA 최대값. 순간적인 발광 난이도.
  3. **원시 난이도 ($D_0$)**: $F$와 $P$의 순위(Rank) 및 분산($V$)을 조합하여 계산.
  4. **생존률 예측 ($S_{hat}$)**: 로지스틱 회귀 모델을 사용하여 특정 난이도에서 클리어 확률 예측.
     $$S_{hat} = \sigma(a - k \cdot D_0)$$
  5. **레벨 추정**: $P$(피크)와 $F$(평균)를 기반으로 1~20 스케일의 레벨로 환산.

#### `hp_model.py`
- **기능**: Osu!mania HP9 게이지 시스템을 시뮬레이션합니다.
- **Qwilight 변환**: Qwilight의 판정(PG, PF, GR...)을 입력받아 HP9 기준 생존 여부를 판단합니다.
- **최대 미스 계산**: HP9 게이지를 유지하기 위한 최대 허용 미스 수를 역산합니다.

### 2.4. GUI

#### `main_gui.py`
- **라이브러리**: `tkinter` 사용.
- **구성**:
  - **Chart Analysis 탭**: 파일 선택, 파라미터 조절, 난이도 그래프(Matplotlib) 시각화.
  - **HP Calculator 탭**: Qwilight 리절트 입력을 통한 HP9 생존 여부 및 통합 난이도 계산.

## 3. 데이터 흐름
1. **파일 로드**: GUI에서 파일 선택 -> `bms_parser` 또는 `osu_parser` 호출.
2. **전처리**: 노트 리스트(`time`, `column`, `type`) 생성.
3. **메트릭 추출**: `metric_calc`에서 윈도우별 데이터 생성.
4. **난이도 산출**: `calc`에서 $F, P, D_0$ 및 레벨 계산.
5. **결과 표시**: 텍스트 결과 및 그래프 출력.

