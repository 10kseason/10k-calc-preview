# Memory for AI and Human Worker

## Project: BMS Difficulty Calculator

### Key Components
- **Parsers**: `bms_parser.py`, `osu_parser.py`
- **Core Logic**: `metric_calc.py` (Metrics), `calc.py` (Difficulty Model), `hp_model.py` (HP9)
- **UI**: `main_gui.py` (Tkinter)

### Documentation
- Detailed implementation notes are in `docs/implementation_details.md`.
- General usage is in `readme.md`.

### Conventions
- Use Korean for documentation and user interactions.
- Always update `docs/` when changing core logic.
- 1-indexed columns for internal processing (1-7, 8-15).

### Recent Updates
- Added Osu! parser support.
- Implemented HP9 model and Qwilight converter.
- Created documentation structure.
- Extended level range to 1-25 (added 'God' tier).
- Implemented Binomial S-Rank model (note count dependent).
- Added Gamma Clear (pessimistic adjustment) and Soft Cap (spike mitigation) layers.

### Latest Progress (2025-11-29)
- **Batch Verification & Tuning**:
    - Analyzed `10Key-Revive-pack` (184 charts) -> MAE 2.01, Bias 0.17.
    - **Action NPS**: Implemented in `metric_calc.py` to fix chord overestimation (10K/14K).
    - **Weight Tuning**: `alpha=0.8` (NPS), `theta=0.5` (Hand), `eta=0.5` (Alt).
    - **D0 Mapping**: Calibrated `D_max=75.0` (Level β‰ D0/3 + 1).
- **Optimization**:
    - Created `optimize_weights.py` to find optimal parameters using `scipy`.
    - Expanded dataset to `10K2S` + `10Key-Revive-pack` (Total ~958 charts).
    - Currently running baseline verification on combined dataset.

### Latest Progress (2025-11-29) - Session 2
- **UI Refinement**:
    - Implemented Developer Mode (`--dev`) to hide advanced params from users.
    - Restored "Optimized Weights", "Uncap Level", "Auto Mode" checkboxes in User Mode.
- **Difficulty Model Refinement (In Progress)**:
    - **Issue**: Previous model saturated D0, causing levels to clamp at 25.
    - **Fixes Applied**:
        - `calc.py`: `D_max=100`, `gamma=1.2`, Soft Clamp (>25), Density-normalized Length Bonus.
        - `metric_calc.py`: Log-scaling for `chord_strain` (`np.log1p`).
        - `optimize_weights.py`: 5-Fold CV, new bounds (`omega` 0.5~2.0).
    - **Current Status**: Optimization run produced high MAE (~6.51).
        - Suspect: `D_max` might be too low for the new log-scaled chord values, or `gamma` is too steep.
        - `debug_calc.py` created to inspect D0 values but not yet run.

### Next Steps (Handover)
1. **Diagnose High MAE**:
    - Run `debug_calc.py` to see actual D0 and Est Level values for sample charts.
    - If D0 is too low (causing Level 1), decrease `D_max` or increase weights.
    - If D0 is too high (causing Level 25+), increase `D_max` or decrease weights.
2. **Re-run Optimization**:
    - Adjust bounds in `optimize_weights.py` based on diagnosis.
    - Run `python optimize_weights.py` again.
3. **Finalize**:
    - Update `main_gui.py` with the new best parameters.
    - Verify with `verify_batch_levels.py`.

### Future Ideas & Suggestions
- **Difficulty Calculation Simplification**:
    - Suggestion: Start with `nps = total note count / song length` as the easiest difficulty metric.
    - Investigation: Check if the difficulty difference between BMS and osu! stems from NPS.
    - Context: User request "λ‚μ¤‘μ— κ³„μ‚°κΈ° μμ •ν• λ• κΈ°μ–µν•΄μ¤?" (Remember this for when we modify the calculator later).

### BMS μ „μ© μ •ν™•λ„ κ°μ„  (2025-12-08)
- **ν•µμ‹¬ λ°κ²¬**: BMS λ°μ΄ν„° 1759κ° λ¶„μ„ κ²°κ³Ό, **NPS μ„ ν• νκ·€κ°€ κ°€μ¥ μ •ν™•**
  - NPS Linear: `level = 0.6963 * NPS + 1.6395`, **MAE 1.55** (RΒ²=0.55)
  - λ¨λΈ κΈ°λ° μµμ ν™”: MAE 2.92 (NPSλ³΄λ‹¤ μ €μ΅°)
- **Feature Ablation κ²°κ³Ό** (MAE):
  - NPS+chord: 2.19 (μµμ„ )
  - NPS+hand: 2.32
  - NPS only: 2.55
  - All features: 2.77 (κ³Όμ ν•©)
  - ν„μ¬ λ¨λΈ(final_params.json): 34.08 (νλΌλ―Έν„° λ¶μΌμΉ)
- **κ²°λ΅ **: BMS λ‚μ΄λ„ μμΈ΅μ—μ„ λ³µμ΅ν• λ¨λΈλ³΄λ‹¤ λ‹¨μ NPS νκ·€κ°€ λ” ν¨κ³Όμ 
- **μƒμ„±λ νμΌ**:
  - `run_bms_only_analysis.py` - BMS μ „μ© λ¶„μ„
  - `ablation_study.py` - ν”Όμ² κΈ°μ—¬λ„ λ¶„μ„
  - `optimize_bms_only.py` - BMS μ „μ© μµμ ν™”
  - `bms_final_params.json` - μµμ ν™” κ²°κ³Ό (MAE 2.92)
  - `ablation_results.json` - Ablation Study κ²°κ³Ό

### NPS ν‘μ¤€ν™” κ²€μ¦ (2025-12-08)
- **λ©μ **: BMSμ™€ OSU νμ„ κ°„ NPS κ³„μ‚° μΌκ΄€μ„± ν™•μΈ
- **ν…μ¤νΈ νμΌ**: `λ¬Έμ λ¶„μ„μ©` ν΄λ”μ CircusGalop [10K HELL CIRCUS]
  - BMS νμΌ: 12,326κ° λ…ΈνΈ, 238.20μ΄, NPS 51.75
  - OSU νμΌ: 12,326κ° λ…ΈνΈ, 238.20μ΄, NPS 51.75
  - **κ²°κ³Ό**: β… μ™„λ²½ν• μΌμΉ (λ…ΈνΈμ μ°¨μ΄ 0κ°, NPS μ°¨μ΄ 0.00)
- **κ²€μ¦ λ‚΄μ©**:
  - λ‘ νμ„ λ¨λ‘ Long Note(LN)λ¥Ό 2κ° λ…ΈνΈ(μ‹μ‘/λ λ§μ»¤)λ΅ κ³„μ‚°
  - κ³΅ κΈΈμ΄λ¥Ό μ²« λ…ΈνΈ~λ§μ§€λ§‰ λ…ΈνΈ μ‹κ°„μΌλ΅ μΌκ΄€λκ² κ³„μ‚°
  - μ΄μ „ λ€ν™”(fce5e1ec)μ—μ„ κµ¬ν„ν• NPS ν‘μ¤€ν™” μ‘μ—… μ„±κ³µ ν™•μΈ
- **μƒμ„±λ νμΌ**:
  - `analyze_nps_test_files.py` - NPS ν…μ¤νΈ νμΌ μλ™ λ¶„μ„ μ¤ν¬λ¦½νΈ

### GUI NPS ν‘μ‹ λ° UI κ°μ„  (2025-12-08)
- **λ©μ **: main_gui.pyμ— νμ„ μ›μ‹ NPS μ •λ³΄ μ¶”κ°€ λ° μ‚¬μ©μ κ²½ν— κ°μ„ 
- **μ£Όμ” λ³€κ²½μ‚¬ν•­**:
  - κ²°κ³Ό ν¨λ„μ— "κΈ°λ³Έ μ§€ν‘" μ„Ήμ… μ¶”κ°€ (Global NPS, ν‰κ·  NPS, Peak NPS, NPS ν‘μ¤€νΈμ°¨)
  - κ³ μ •ν­ ν°νΈ(Consolas) μ μ©μΌλ΅ μ«μ μ •λ ¬ κ°μ„ 
  - μ λ‹μ½”λ“ λ°•μ¤ λ¬Έμ(β•, β”€) λ° μ΄λ¨μ§€ μ•„μ΄μ½μΌλ΅ μ„Ήμ… κµ¬λ¶„ κ°•ν™”
  - κ²°κ³Ό ν…μ¤νΈ λ°•μ¤ ν¬κΈ° ν™•λ€ (10β†’15 height, 40β†’50 width)
  - κ·Έλν”„ DPI 100 μ„¤μ •μΌλ΅ μ„ λ…λ„ ν–¥μƒ
- **ν¨κ³Ό**: 
  - νμ„ μ›μ‹κ°’κ³Ό λ¨λΈ κ³„μ‚°κ°’ μ§μ ‘ λΉ„κµ κ°€λ¥
  - κ°€λ…μ„± λ€ν­ ν–¥μƒμΌλ΅ μ •λ³΄ νμ•… μ©μ΄
  - μ „λ¬Έμ μ΄λ©΄μ„λ„ μΉκ·Όν• UI μ κ³µ
- **ν…μ¤νΈ**: 10e.bmsλ΅ κ²€μ¦ μ™„λ£, λ¨λ“  κΈ°λ¥ μ •μƒ μ‘λ™ ν™•μΈ

### λ””λ²„κ·Έ λ¨λ“ μ¶”κ°€ (2025-12-08)
- **λ©μ **: GUIμ—μ„ μƒμ„Έν• λ””λ²„κΉ… μ •λ³΄λ¥Ό ν™•μΈν•  μ μλ” κΈ°λ¥ μ¶”κ°€
- **κµ¬ν„ λ‚΄μ©**:
  - User Optionsμ— "π”§ λ””λ²„κ·Έ λ¨λ“" μ²΄ν¬λ°•μ¤ μ¶”κ°€
  - λ””λ²„κ·Έ λ¨λ“ ν™μ„±ν™” μ‹ λ‹¤μ μ •λ³΄ ν‘μ‹:
    * π“ λ…ΈνΈ νƒ€μ… λ¶„ν¬ (ln_start, ln_end, note λ“±)
    * π“ λ¨λ“  Metrics ν†µκ³„ (μµμ†/μµλ€/ν‰κ· /μ¤‘μ•™κ°’/ν‘μ¤€νΈμ°¨)
    * π” μλ„μ°λ³„ μƒμ„Έ μ •λ³΄ (μ²μ 10κ°, λ§μ§€λ§‰ 10κ°)
    * β™οΈ μ‚¬μ©λ λ¨λΈ νλΌλ―Έν„° (Legacy λ¨λΈ μ‚¬μ© μ‹)
    * π“„ νμ„ μƒμ„Έ μ •λ³΄ (ν—¤λ”, BPM μ •μ λ“±)
- **ν™μ©**: 
  - λ‚μ΄λ„ κ³„μ‚° λ¬Έμ  μ§„λ‹¨
  - Metric κ°’ κ²€μ¦
  - νμΌ νμ‹± μ¤λ¥ λ””λ²„κΉ…
  - λ¨λΈ νλΌλ―Έν„° ν™•μΈ

### new_calc.py λ¨λ“ μƒμ„± λ° ν†µν•© (2025-12-08)
- **λ©μ **: μ„ ν• νκ·€ NPS λ¨λΈμ„ λ…λ¦½ λ¨λ“λ΅ λ¶„λ¦¬ν•μ—¬ μ¬μ‚¬μ©μ„± ν–¥μƒ
- **μ£Όμ” κΈ°λ¥**:
  - `predict_level_linear()`: 3-feature μ„ ν• νκ·€ (global_nps, nps_std, chord_mean)
  - `predict_level_simple()`: λ‹¨μ NPS μ„ ν• νκ·€
  - `predict_from_notes()`: λ…ΈνΈ λ°μ΄ν„°μ—μ„ μ§μ ‘ λ λ²¨ μμΈ΅
  - `get_level_label()`: λ λ²¨μ„ ν‹°μ–΄ λ μ΄λΈ”λ΅ λ³€ν™
  - `calculate_nps_metrics()`: NPS κ΄€λ ¨ λ©”νΈλ¦­ μλ™ κ³„μ‚°
  - `compare_models()`: λ‘ λ¨λΈ λΉ„κµ μ ν‹Έλ¦¬ν‹°
- **λ¨λΈ νλΌλ―Έν„°** (NPS_LINEAR_PARAMS):
  - intercept: -0.1879
  - coef_nps: 0.2053
  - coef_std: 0.9999
  - coef_chord: 3.2741
  - BMS 1759κ° κΈ°μ¤€ MAE 1.12
- **main_gui.py ν†µν•©**:
  - new_calc λ¨λ“ μ„ν¬νΈ
  - ν•λ“μ½”λ”©λ nps_linear_params μ κ±°
  - predict_from_notes() ν•¨μλ΅ λ λ²¨ κ³„μ‚°
  - μ½”λ“ κ°„κ²°ν™” λ° μ μ§€λ³΄μμ„± ν–¥μƒ
- **ν¨κ³Ό**:
  - λ‹¤λ¥Έ μ¤ν¬λ¦½νΈμ—μ„λ„ μ„ ν• λ¨λΈ μ‰½κ² μ‚¬μ© κ°€λ¥
  - μ¤‘λ³µ μ½”λ“ μ κ±°
  - λ¨λΈ νλΌλ―Έν„° μ¤‘μ•™ κ΄€λ¦¬

### λ΅μ»¬ NPS κ³„μ‚° λ°©μ‹ λ³€κ²½ (2025-12-08)
- **λ©μ **: Peak NPSλ¥Ό λ” μ •ν™•ν•κ² μΈ΅μ •ν•κΈ° μ„ν•΄ λ΅μ»¬ NPS κ³„μ‚° λ°©μ‹ κ°μ„ 
- **λ³€κ²½ λ‚΄μ©**:
  - **Global NPS**: μ΄ λ…ΈνΈμ / κ³΅ κΈΈμ΄ (μ μ§€)
  - **Local NPS**: κ° λ…ΈνΈλ¥Ό μ¤‘μ‹¬μΌλ΅ Β±500ms κµ¬κ°„ λ‚΄ λ…ΈνΈ κ°μ (μ‹ κ·)
  - **Peak NPS**: λ¨λ“  λ΅μ»¬ NPS μ¤‘ μµλ€κ°’ (μ‹ κ·)
  - **NPS std**: 1μ΄ μλ„μ°λ³„ NPSμ ν‘μ¤€νΈμ°¨ (μ μ§€)
- **κµ¬ν„ μ„μΉ**: `new_calc.py`μ `calculate_nps_metrics()` ν•¨μ
- **κ²€μ¦**:
  - XRATE νμΌ: Peak NPS = 100 β…
  - CircusGalop: Peak NPS = 176
- **ν¨κ³Ό**:
  - μκ°„ μµλ€ λ°€λ„λ¥Ό λ” μ •ν™•ν•κ² μΈ΅μ •
  - λ…ΈνΈ μ¤‘μ‹¬ κΈ°μ¤€μΌλ΅ κµ­μ§€μ  λ‚μ΄λ„ νμ•…
  - κΈ°μ΅΄ 1μ΄ μλ„μ° λ°©μ‹λ³΄λ‹¤ μ •λ°€ν• Peak κ°μ§€

### λ””λ²„κ·Έ OSU λ‚΄λ³΄λ‚΄κΈ° κΈ°λ¥ μ¶”κ°€ (2025-12-08)
- **λ©μ **: κ° λ…ΈνΈμ λ©”νΈλ¦­ κ°’μ„ μ¤μ¤ μ—λ””ν„°μ—μ„ μ‹κ°μ μΌλ΅ ν™•μΈ
- **κµ¬ν„ λ‚΄μ©**:
  - `debug_osu_export.py`: λ””λ²„κ·Έμ© .osu νμΌ μƒμ„± λ¨λ“
  - κ° λ…ΈνΈμ λ©”νΈλ¦­ κ°’μ„ ν‚¤μ νμΌλ…μΌλ΅ ν‘μ‹
    * `n12.wav`: Local NPS = 12
    * `j16.50.wav`: Jack = 16.50
    * `c3.14.wav`: Chord = 3.14
  - 5κ°€μ§€ λ¨λ“λ΅ μƒμ„±:
    * local_nps: λ΅μ»¬ NPS (Β±500ms)
    * jack: Jack λ°€λ„
    * chord: Chord strain
    * hand: Hand strain
    * all: λ¨λ“  λ©”νΈλ¦­ (n12_j16_c3.1)
  - GUIμ— "π” Debug OSU" λ²„νΌ μ¶”κ°€
- **μ‚¬μ©λ²•**:
  1. νμΌ κ³„μ‚° (Calculate λ²„νΌ)
  2. Debug OSU λ²„νΌ ν΄λ¦­
  3. μ €μ¥ μ„μΉ μ„ νƒ
  4. μƒμ„±λ .osu νμΌμ„ μ¤μ¤ μ—λ””ν„°μ—μ„ μ—΄μ–΄ λ©”νΈλ¦­ ν™•μΈ
- **ν¨κ³Ό**:
  - λ…ΈνΈλ³„ λ©”νΈλ¦­μ„ μ‹κ°μ μΌλ΅ λ””λ²„κΉ…
  - λ¬Έμ  κµ¬κ°„μ„ ν•λμ— νμ•…
  - λ¨λΈ κ²€μ¦ λ° νλ‹μ— μ μ©

### ν•µμ‹¬ λ΅μ§ λ¬Έμ„ν™” (2025-12-08)
- **λ©μ **: BMS/OSU νμ„ λ° new_calc λ¨λ“μ μ λ€ κΈ°μ¤€ λ΅μ§μ„ λ¬Έμ„ν™”
- **μƒμ„± λ¬Έμ„**: `docs/core_logic_reference.md`
- **λ¬Έμ„ λ‚΄μ©**:
  1. **BMS νμ„ μ±„λ„ λ§¤ν•‘**: 11-19, 21-29, 51-59, 61-69 μ±„λ„ β†’ μ—΄(column) λ§¤ν•‘
  2. **OSU νμ„ μ—΄ κ³„μ‚°**: floor(x * key_count / 512) + 1
  3. **NPS κ³„μ‚° ν‘μ¤€**:
     - Global NPS = total_notes / duration
     - Local NPS = κ° λ…ΈνΈ μ¤‘μ‹¬ Β±500ms κµ¬κ°„ λ‚΄ λ…ΈνΈ κ°μ
     - Peak NPS = max(Local NPS)
     - NPS std = 1μ΄ μλ„μ°λ³„ NPS ν‘μ¤€νΈμ°¨
  4. **λ…ΈνΈ νƒ€μ… μ •μ**: note, ln_start, ln_end, ln_marker
  5. **μ„ ν• λ¨λΈ νλΌλ―Έν„°**: intercept=-0.1879, coef_nps=0.2053, coef_std=0.9999, coef_chord=3.2741

### BMS ν‚¤ λ¨λ“ μλ™ κ°μ§€ κµ¬ν„ (2025-12-10)
- **λ©μ **: λ‹¤μ–‘ν• BMS ν‚¤ λ¨λ“(4K~16K)λ¥Ό μλ™ κ°μ§€ν•κ³  μ¬λ°”λ¥Έ μ—΄ λ§¤ν•‘ μ μ©
- **μ£Όμ” λ³€κ²½**:
  1. **ν‚¤ λ¨λ“ ν¨ν„΄ ν…μ΄λΈ”** (`bms_parser.py`):
     - 4K, 5K, 5+1, 6K, 7K, 7+1, 9K_PMS, 10K, DP12, DP14, DP16
     - μ‚¬μ©λ μ±„λ„ ν¨ν„΄μΌλ΅ κ°€μ¥ μ‘μ€ superset λ§¤μΉ­
  2. **ν‚¤ λ¨λ“λ³„ μ—΄ λ§¤ν•‘**:
     - λ¨λ“  ν‚¤ λ¨λ“μ—μ„ μ—΄μ€ 1-indexed (1λ¶€ν„° μ‹μ‘)
     - LN μ±„λ„(5x/6x)μ€ μλ™μΌλ΅ μΌλ° μ±„λ„(1x/2x)κ³Ό λ™μΌ μ—΄ λ§¤ν•‘
  3. **κ°μ§€ λ΅μ§** (`_detect_key_mode()` λ©”μ„λ“):
     - `_process_data()` μ‹μ‘ μ‹ νΈμ¶
     - `detected_mode`, `key_count`, `play_mode` μ†μ„± μ„¤μ •
- **debug_osu_export.py μμ •**:
  1. **key_count νλΌλ―Έν„°** μ¶”κ°€ (νμ„μ—μ„ μ „λ‹¬)
  2. **x μΆν‘ κ³„μ‚°** μμ •: λ¨λ“  ν‚¤ λ¨λ“μ—μ„ `column - 1`λ΅ 0-indexed λ³€ν™
  3. **CircleSize** λ™μ  μ„¤μ • (key_countμ— λ§κ²)
  4. **λ΅±λ…ΈνΈ λ¨Έλ¦¬/κΌ¬λ¦¬ λ©”νΈλ¦­ λ¶„λ¦¬ ν‘μ‹**: `Hn12_Tn15.wav` ν•μ‹
- **ν…μ¤νΈ κ²°κ³Ό**:
  - XRATE: DP12 (12ν‚¤) β…
  - test_sample.bms: 5K (5ν‚¤) β…
- **λ¬Έμ„ μ—…λ°μ΄νΈ**: `docs/core_logic_reference.md`μ— ν‚¤ λ¨λ“ κ°μ§€ λ΅μ§ λ°μ

### NPS κ³„μ‚° λ¶€λ™μ†μμ  μ¤μ°¨ λ°©μ§€ (2025-12-10)
- **λ¬Έμ μ **: Local NPS κ³„μ‚° μ‹ `t + 0.5`(500ms) μ΅°κ±΄μ—μ„ λ¶€λ™μ†μμ  μ¤μ°¨λ΅ μΈν•΄
  - μ‹¤μ λ΅ κ°™μ€ μ‹κ°„(t+500ms)μΈ λ…ΈνΈκ°€ "λ³΄λ‹¤ μ‘λ‹¤(<)" μ΅°κ±΄μ— ν¬ν•¨λλ” ν„μƒ λ°μƒ
  - BMSμ™€ OSU κ°„ NPS κ²°κ³Ό λ¶μΌμΉ κ°€λ¥μ„±
- **ν•΄κ²° λ°©λ²•**:
  1. **λ…ΈνΈ μ‹κ°„ λ°μ¬λ¦Ό**: `round(time, 3)` - ms λ‹¨μ„λ΅ λ°μ¬λ¦Όν•μ—¬ λ¶€λ™μ†μμ  μ¤μ°¨ μ κ±°
  2. **μλ„μ° κ²½κ³„ μ΅°μ •**: `window_end = t + 0.499999999999` + `<=` λΉ„κµ μ‚¬μ©
- **μμ •λ νμΌ**:
  - `bms_parser.py`: λ…ΈνΈ μƒμ„± μ‹ `round(current_time, 3)` μ μ© (351, 358λ² λΌμΈ)
  - `osu_parser.py`: λ…ΈνΈ μƒμ„± μ‹ `round(time_ms / 1000.0, 3)` μ μ© (86-88, 92, 105λ² λΌμΈ)
  - `new_calc.py`: Local NPS κ³„μ‚°μ—μ„ `round(note['time'], 3)` λ° `window_end = t + 0.499999999999` μ μ©
  - `debug_osu_export.py`: Local NPS κ³„μ‚° λ΅μ§ λ™μΌ μμ •
  - `test_local_nps.py`, `test_xrate_peak.py`: ν…μ¤νΈ μ¤ν¬λ¦½νΈ λ™μΌ μμ •
- **κ²€μ¦ κ²°κ³Ό** (CircusGalop BMS vs OSU):
  - λ…ΈνΈμ: 12,326 vs 12,326 β…
  - μ‹κ°„ μ°¨μ΄: 0.0ms β…
  - NPS ν‘μ¤€νΈμ°¨: 27.6422 vs 27.6422 β…
  - Peak NPS: 176 vs 176 β…
- **ν¨κ³Ό**:
  - BMS/OSU κ°„ NPS κ³„μ‚° μ™„λ²½ μΌμΉ
  - λ¶€λ™μ†μμ  μ¤μ°¨λ΅ μΈν• 1μ΄ μλ„μ° κ²½κ³„ λ°€λ¦Ό λ¬Έμ  ν•΄κ²°

